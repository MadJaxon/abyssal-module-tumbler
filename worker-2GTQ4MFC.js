addEventListener("message",e=>{switch(e.data.action){case"findCombinations":postMessage({action:e.data.action,data:O(e.data.data),isUpdate:!1});break;case"sort":postMessage({action:e.data.action,data:L(e.data.data),isUpdate:!1});break;default:postMessage({action:"sort",data:null,error:"unknown action",isUpdate:!1})}});function L(e){if(Object.values(e.sorts).length===0)return e.results=e.makeUnique?B(e.results):e.results,e;let s=e.results.sort((a,c)=>{for(let n of Object.values(e.sorts)){let r=a[n.key],u=c[n.key];if(r==null&&u==null)continue;if(r==null)return n.direction==="asc"?-1:1;if(u==null)return n.direction==="asc"?1:-1;if(typeof r=="number"&&typeof u=="number"){if(r<u)return n.direction==="asc"?-1:1;if(r>u)return n.direction==="asc"?1:-1;continue}let o=String(r).toLowerCase(),l=String(u).toLowerCase();if(o<l)return n.direction==="asc"?-1:1;if(o>l)return n.direction==="asc"?1:-1}return 0});return e.results=e.makeUnique?B(s):s,e}function B(e){let s=[];return e.filter(a=>{let c=!0,n=[];return a.modules.forEach(r=>{s.some(u=>u.type===r.type&&u.index===r.index)&&(c=!1),n.push({type:r.type,index:r.index})}),c&&(s=s.concat(n)),c})}function O(e){let s=Object.keys(e.numModules).reduce((n,r)=>(n+=e.numModules[r],n),0);if(!e.cpuBudget||!e.pgBudget||!e.numModules||s<=0){e.error="Please enter valid budget and number of modules.";return}let a=[];return E(e.modules,e.numModules).forEach((n,r)=>{let u=n.reduce((l,d)=>l+d.cpu,0),o=n.reduce((l,d)=>l+d.pg,0);if(u<=e.cpuBudget&&o<=e.pgBudget){let l=N(n.filter(t=>t.type==="dps")),d=n.filter(t=>t.type==="sb"),f=d.reduce((t,i)=>t+i.damage/(i.activationTime/1e3),0),b=d.reduce((t,i)=>t+i.activationCost/(i.activationTime/1e3),0),p=d.length===0?0:d.reduce((t,i)=>t+i.range,0)/d.length,m=n.filter(t=>t.type==="neut"),g=m.reduce((t,i)=>t+i.neutAmount/(i.activationTime/1e3),0),y=m.reduce((t,i)=>t+i.activationCost/(i.activationTime/1e3),0),D=m.length===0?0:m.reduce((t,i)=>t+i.range,0)/m.length,M=n.filter(t=>t.type==="nos"),w=M.reduce((t,i)=>t+i.drainAmount/(i.activationTime/1e3),0),W=M.length===0?0:M.reduce((t,i)=>t+i.range,0)/M.length,k=n.filter(t=>t.type==="battery"),S=k.reduce((t,i)=>t+i.capacitorBonus,0),j=q(k),R=n.filter(t=>t.type==="ab"),A=Math.max(...R.map(t=>t.velocityBonus)),C=Math.max(...R.map(t=>t.activationCost)),h=n.filter(t=>t.type==="mwd"),I=Math.max(...h.map(t=>t.velocityBonus)),x=Math.max(...h.map(t=>t.activationCost)),U=Math.max(...h.map(t=>t.signatureRadiusModifier)),G=Math.max(0,b)+Math.max(0,y)+Math.max(0,C,x);a.push({id:r,modules:n.map(t=>({type:t.type,index:t.index,itemId:t.itemId,typeId:t.typeId})),totalCpu:u,totalPg:o,dpsIncrease:l,smartbombDps:f,smartbombGjs:b,smartbombRange:p,neutAmount:g,neutGjs:y,neutRange:D,nosAmount:w,nosRange:W,capBonus:S,drainResistance:j,abVelocity:A,abGj:C,mwdVelocity:I,mwdGj:x,mwdSignature:U,totalGj:G}),postMessage({action:"findCombinations",data:a.length,isUpdate:!0})}}),e.results=a,e}function v(e,s){if(s===0)return[[]];if(e.length<s)return[];let a=[];for(let c=0;c<=e.length-s;c++){let n=e[c],r=v(e.slice(c+1),s-1);for(let u of r)a.push([n,...u])}return a}function T(e){return e.reduce((s,a)=>{let c=[];for(let n of s)for(let r of a)c.push([...n,...r]);return c},[[]])}function E(e,s){let a={},c=Object.keys(e);for(let u of c){let o=e[u],l=s[u]??0,d=[];for(let f=0;f<=Math.min(l,o.length);f++){let p=v(o,f);for(let m=0;m<p.length;m+=100){let g=p.slice(m,m+100);d.push(...g)}}a[u]=d}let n=c.map(u=>a[u]);return T(n).filter(u=>!Object.keys(s).some(o=>u.filter(l=>l.type===o).length!==s[o]))}function N(e){let s=e.map(o=>o.dmgMulti-1),a=e.map(o=>o.rofBonus/100);s.sort((o,l)=>l-o),a.sort((o,l)=>l-o);let c=1;for(let o=0;o<s.length;o++){let l=Math.exp(-Math.pow(o/2.67,2));c*=1+s[o]*l}let n=1;for(let o=0;o<a.length;o++){let l=Math.exp(-Math.pow(o/2.67,2));n*=1-a[o]*l}let r=n>0?1/n:1;return(c*r-1)*100}function q(e){let s=e.map(n=>Math.abs(n.drainResistanceBonus)/100);s.sort((n,r)=>r-n);let a=1;for(let n=0;n<s.length;n++){let r=Math.exp(-Math.pow(n/2.67,2));a*=1-s[n]*r}return-((1-a)*100)}
