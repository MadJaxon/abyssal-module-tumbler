addEventListener("message",t=>{switch(t.data.action){case"findCombinations":postMessage({action:t.data.action,data:O(t.data.data),isUpdate:!1});break;case"sort":postMessage({action:t.data.action,data:G(t.data.data),isUpdate:!1});break;default:postMessage({action:"sort",data:null,error:"unknown action",isUpdate:!1})}});function G(t){let s=t.makeUnique?L(t.results):t.results;return Object.values(t.sorts).length===0?(t.results=s,t):(t.results=s.sort((u,l)=>{for(let n of Object.values(t.sorts)){let r=u[n.key],a=l[n.key];if(r==null&&a==null)continue;if(r==null)return n.direction==="asc"?-1:1;if(a==null)return n.direction==="asc"?1:-1;if(typeof r=="number"&&typeof a=="number"){if(r<a)return n.direction==="asc"?-1:1;if(r>a)return n.direction==="asc"?1:-1;continue}let o=String(r).toLowerCase(),c=String(a).toLowerCase();if(o<c)return n.direction==="asc"?-1:1;if(o>c)return n.direction==="asc"?1:-1}return 0}),t)}function L(t){let s=[];return t.filter(u=>{let l=!0,n=[];return u.modules.forEach(r=>{s.some(a=>a.type===r.type&&a.index===r.index)&&(l=!1),n.push({type:r.type,index:r.index})}),l&&(s=s.concat(n)),l})}function O(t){let s=Object.keys(t.numModules).reduce((n,r)=>(n+=t.numModules[r],n),0);if(!t.cpuBudget||!t.pgBudget||!t.numModules||s<=0){t.error="Please enter valid budget and number of modules.";return}let u=[];return E(t.modules,t.numModules).forEach((n,r)=>{let a=n.reduce((c,d)=>c+d.cpu,0),o=n.reduce((c,d)=>c+d.pg,0);if(a<=t.cpuBudget&&o<=t.pgBudget){let c=N(n.filter(e=>e.type==="dps")),d=n.filter(e=>e.type==="sb"),m=d.reduce((e,i)=>e+i.damage/(i.activationTime/1e3),0),b=d.reduce((e,i)=>e+i.activationCost/(i.activationTime/1e3),0),x=d.length===0?0:d.reduce((e,i)=>e+i.range,0)/d.length,f=n.filter(e=>e.type==="neut"),B=f.reduce((e,i)=>e+i.neutAmount/(i.activationTime/1e3),0),g=f.reduce((e,i)=>e+i.activationCost/(i.activationTime/1e3),0),v=f.length===0?0:f.reduce((e,i)=>e+i.range,0)/f.length,p=n.filter(e=>e.type==="nos"),D=p.reduce((e,i)=>e+i.drainAmount/(i.activationTime/1e3),0),w=p.length===0?0:p.reduce((e,i)=>e+i.range,0)/p.length,h=n.filter(e=>e.type==="battery"),W=h.reduce((e,i)=>e+i.capacitorBonus,0),S=P(h),y=n.filter(e=>e.type==="ab"),j=Math.max(...y.map(e=>e.velocityBonus)),k=Math.max(...y.map(e=>e.activationCost)),M=n.filter(e=>e.type==="mwd"),A=Math.max(...M.map(e=>e.velocityBonus)),R=Math.max(...M.map(e=>e.activationCost)),I=Math.max(...M.map(e=>e.signatureRadiusModifier)),U=Math.max(0,b)+Math.max(0,g)+Math.max(0,k,R);u.push({id:r,modules:n.map(e=>({type:e.type,index:e.index,itemId:e.itemId,typeId:e.typeId})),totalCpu:a,totalPg:o,dpsIncrease:c,smartbombDps:m,smartbombGjs:b,smartbombRange:x,neutAmount:B,neutGjs:g,neutRange:v,nosAmount:D,nosRange:w,capBonus:W,drainResistance:S,abVelocity:j,abGj:k,mwdVelocity:A,mwdGj:R,mwdSignature:I,totalGj:U}),postMessage({action:"findCombinations",data:u.length,isUpdate:!0})}}),t.results=u,t}function C(t,s){if(s===0)return[[]];if(t.length<s)return[];let u=[];for(let l=0;l<=t.length-s;l++){let n=t[l],r=C(t.slice(l+1),s-1);for(let a of r)u.push([n,...a])}return u}function T(t){return t.reduce((s,u)=>{let l=[];for(let n of s)for(let r of u)l.push([...n,...r]);return l},[[]])}function E(t,s){let u={},l=Object.keys(t);for(let a of l){let o=t[a],c=s[a]??0,d=[];for(let m=0;m<=Math.min(c,o.length);m++)d.push(...C(o,m));u[a]=d}let n=l.map(a=>u[a]);return T(n).filter(a=>!Object.keys(s).some(o=>a.filter(c=>c.type===o).length!==s[o]))}function N(t){let s=t.map(o=>o.dmgMulti-1),u=t.map(o=>o.rofBonus/100);s.sort((o,c)=>c-o),u.sort((o,c)=>c-o);let l=1;for(let o=0;o<s.length;o++){let c=Math.exp(-Math.pow(o/2.67,2));l*=1+s[o]*c}let n=1;for(let o=0;o<u.length;o++){let c=Math.exp(-Math.pow(o/2.67,2));n*=1-u[o]*c}let r=n>0?1/n:1;return(l*r-1)*100}function P(t){let s=t.map(n=>Math.abs(n.drainResistanceBonus)/100);s.sort((n,r)=>r-n);let u=1;for(let n=0;n<s.length;n++){let r=Math.exp(-Math.pow(n/2.67,2));u*=1-s[n]*r}return-((1-u)*100)}
