addEventListener("message",n=>{switch(n.data.action){case"findCombinations":postMessage({action:n.data.action,data:I(n.data.data),isUpdate:!1});break;case"sort":postMessage({action:n.data.action,data:T(n.data.data),isUpdate:!1});break;default:postMessage({action:"sort",data:null,error:"unknown action",isUpdate:!1})}});function T(n){return n.results=n.results.sort((r,i)=>{for(let s of Object.values(n.sorts)){let e=r[s.key],u=i[s.key];if(e==null&&u==null)continue;if(e==null)return s.direction==="asc"?-1:1;if(u==null)return s.direction==="asc"?1:-1;if(typeof e=="number"&&typeof u=="number"){if(e<u)return s.direction==="asc"?-1:1;if(e>u)return s.direction==="asc"?1:-1;continue}let c=String(e).toLowerCase(),o=String(u).toLowerCase();if(c<o)return s.direction==="asc"?-1:1;if(c>o)return s.direction==="asc"?1:-1}return 0}),n}function I(n){let r=Object.keys(n.numModules).reduce((e,u)=>(e+=n.numModules[u],e),0);if(!n.cpuBudget||!n.pgBudget||!n.numModules||r<=0){n.error="Please enter valid budget and number of modules.";return}let i=[];O(n.modules,n.numModules).forEach((e,u)=>{let c=e.reduce((l,d)=>l+d.cpu,0),o=e.reduce((l,d)=>l+d.pg,0);if(c<=n.cpuBudget&&o<=n.pgBudget){let l=U(e.filter(t=>t.type==="dps")),d=e.filter(t=>t.type==="sb"),m=d.reduce((t,a)=>t+a.damage/(a.activationTime/1e3),0),b=d.reduce((t,a)=>t+a.activationCost/(a.activationTime/1e3),0),B=d.length===0?0:d.reduce((t,a)=>t+a.range,0)/d.length,f=e.filter(t=>t.type==="neut"),v=f.reduce((t,a)=>t+a.neutAmount/(a.activationTime/1e3),0),g=f.reduce((t,a)=>t+a.activationCost/(a.activationTime/1e3),0),D=f.length===0?0:f.reduce((t,a)=>t+a.range,0)/f.length,p=e.filter(t=>t.type==="nos"),w=p.reduce((t,a)=>t+a.drainAmount/(a.activationTime/1e3),0),W=p.length===0?0:p.reduce((t,a)=>t+a.range,0)/p.length,h=e.filter(t=>t.type==="battery"),x=h.reduce((t,a)=>t+a.capacitorBonus,0),S=E(h),y=e.filter(t=>t.type==="ab"),j=Math.max(...y.map(t=>t.velocityBonus)),k=Math.max(...y.map(t=>t.activationCost)),M=e.filter(t=>t.type==="mwd"),A=Math.max(...M.map(t=>t.velocityBonus)),C=Math.max(...M.map(t=>t.activationCost)),G=Math.max(...M.map(t=>t.signatureRadiusModifier)),L=b+g+Math.max(k,C);i.push({id:u,modules:e.map(t=>({type:t.type,index:t.index,itemId:t.itemId})),totalCpu:c,totalPg:o,dpsIncrease:l,smartbombDps:m,smartbombGjs:b,smartbombRange:B,neutAmount:v,neutGjs:g,neutRange:D,nosAmount:w,nosRange:W,capBonus:x,drainResistance:S,abVelocity:j,abGj:k,mwdVelocity:A,mwdGj:C,mwdSignature:G,totalGj:L}),postMessage({action:"findCombinations",data:i.length,isUpdate:!0})}});debugger;return n.results=i,n}function R(n,r){if(r===0)return[[]];if(n.length<r)return[];let i=[];for(let s=0;s<=n.length-r;s++){let e=n[s],u=R(n.slice(s+1),r-1);for(let c of u)i.push([e,...c])}return i}function N(n){return n.reduce((r,i)=>{let s=[];for(let e of r)for(let u of i)s.push([...e,...u]);return s},[[]])}function O(n,r){let i={},s=Object.keys(n);for(let c of s){let o=n[c],l=r[c]??0,d=[];for(let m=0;m<=Math.min(l,o.length);m++)d.push(...R(o,m));i[c]=d}let e=s.map(c=>i[c]);return N(e).filter(c=>!Object.keys(r).some(o=>c.filter(l=>l.type===o).length!==r[o]))}function U(n){let r=n.map(o=>o.dmgMulti-1),i=n.map(o=>o.rofBonus/100);r.sort((o,l)=>l-o),i.sort((o,l)=>l-o);let s=1;for(let o=0;o<r.length;o++){let l=Math.exp(-Math.pow(o/2.67,2));s*=1+r[o]*l}let e=1;for(let o=0;o<i.length;o++){let l=Math.exp(-Math.pow(o/2.67,2));e*=1-i[o]*l}let u=e>0?1/e:1;return(s*u-1)*100}function E(n){let r=n.map(e=>Math.abs(e.drainResistanceBonus)/100);r.sort((e,u)=>u-e);let i=1;for(let e=0;e<r.length;e++){let u=Math.exp(-Math.pow(e/2.67,2));i*=1-r[e]*u}return-((1-i)*100)}
