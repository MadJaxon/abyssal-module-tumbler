addEventListener("message",e=>{switch(e.data.action){case"findCombinations":postMessage({action:e.data.action,data:O(e.data.data),isUpdate:!1});break;case"sort":postMessage({action:e.data.action,data:G(e.data.data),isUpdate:!1});break;default:postMessage({action:"sort",data:null,error:"unknown action",isUpdate:!1})}});function G(e){let s=e.makeUnique?L(e.results):e.results;return Object.values(e.sorts).length===0?(e.results=s,e):(e.results=s.sort((a,l)=>{for(let n of Object.values(e.sorts)){let r=a[n.key],u=l[n.key];if(r==null&&u==null)continue;if(r==null)return n.direction==="asc"?-1:1;if(u==null)return n.direction==="asc"?1:-1;if(typeof r=="number"&&typeof u=="number"){if(r<u)return n.direction==="asc"?-1:1;if(r>u)return n.direction==="asc"?1:-1;continue}let o=String(r).toLowerCase(),c=String(u).toLowerCase();if(o<c)return n.direction==="asc"?-1:1;if(o>c)return n.direction==="asc"?1:-1}return 0}),e)}function L(e){let s=[];return e.filter(a=>{let l=!0,n=[];return a.modules.forEach(r=>{s.some(u=>u.type===r.type&&u.index===r.index)&&(l=!1),n.push({type:r.type,index:r.index})}),l&&(s=s.concat(n)),l})}function O(e){let s=Object.keys(e.numModules).reduce((n,r)=>(n+=e.numModules[r],n),0);if(!e.cpuBudget||!e.pgBudget||!e.numModules||s<=0){e.error="Please enter valid budget and number of modules.";return}let a=[];E(e.modules,e.numModules).forEach((n,r)=>{let u=n.reduce((c,d)=>c+d.cpu,0),o=n.reduce((c,d)=>c+d.pg,0);if(u<=e.cpuBudget&&o<=e.pgBudget){let c=N(n.filter(t=>t.type==="dps")),d=n.filter(t=>t.type==="sb"),m=d.reduce((t,i)=>t+i.damage/(i.activationTime/1e3),0),b=d.reduce((t,i)=>t+i.activationCost/(i.activationTime/1e3),0),x=d.length===0?0:d.reduce((t,i)=>t+i.range,0)/d.length,f=n.filter(t=>t.type==="neut"),B=f.reduce((t,i)=>t+i.neutAmount/(i.activationTime/1e3),0),g=f.reduce((t,i)=>t+i.activationCost/(i.activationTime/1e3),0),v=f.length===0?0:f.reduce((t,i)=>t+i.range,0)/f.length,p=n.filter(t=>t.type==="nos"),D=p.reduce((t,i)=>t+i.drainAmount/(i.activationTime/1e3),0),w=p.length===0?0:p.reduce((t,i)=>t+i.range,0)/p.length,h=n.filter(t=>t.type==="battery"),W=h.reduce((t,i)=>t+i.capacitorBonus,0),S=P(h),y=n.filter(t=>t.type==="ab"),j=Math.max(...y.map(t=>t.velocityBonus)),k=Math.max(...y.map(t=>t.activationCost)),M=n.filter(t=>t.type==="mwd"),A=Math.max(...M.map(t=>t.velocityBonus)),R=Math.max(...M.map(t=>t.activationCost)),U=Math.max(...M.map(t=>t.signatureRadiusModifier)),I=Math.max(0,b)+Math.max(0,g)+Math.max(0,k,R);a.push({id:r,modules:n.map(t=>({type:t.type,index:t.index,itemId:t.itemId})),totalCpu:u,totalPg:o,dpsIncrease:c,smartbombDps:m,smartbombGjs:b,smartbombRange:x,neutAmount:B,neutGjs:g,neutRange:v,nosAmount:D,nosRange:w,capBonus:W,drainResistance:S,abVelocity:j,abGj:k,mwdVelocity:A,mwdGj:R,mwdSignature:U,totalGj:I}),postMessage({action:"findCombinations",data:a.length,isUpdate:!0})}});debugger;return e.results=a,e}function C(e,s){if(s===0)return[[]];if(e.length<s)return[];let a=[];for(let l=0;l<=e.length-s;l++){let n=e[l],r=C(e.slice(l+1),s-1);for(let u of r)a.push([n,...u])}return a}function T(e){return e.reduce((s,a)=>{let l=[];for(let n of s)for(let r of a)l.push([...n,...r]);return l},[[]])}function E(e,s){let a={},l=Object.keys(e);for(let u of l){let o=e[u],c=s[u]??0,d=[];for(let m=0;m<=Math.min(c,o.length);m++)d.push(...C(o,m));a[u]=d}let n=l.map(u=>a[u]);return T(n).filter(u=>!Object.keys(s).some(o=>u.filter(c=>c.type===o).length!==s[o]))}function N(e){let s=e.map(o=>o.dmgMulti-1),a=e.map(o=>o.rofBonus/100);s.sort((o,c)=>c-o),a.sort((o,c)=>c-o);let l=1;for(let o=0;o<s.length;o++){let c=Math.exp(-Math.pow(o/2.67,2));l*=1+s[o]*c}let n=1;for(let o=0;o<a.length;o++){let c=Math.exp(-Math.pow(o/2.67,2));n*=1-a[o]*c}let r=n>0?1/n:1;return(l*r-1)*100}function P(e){let s=e.map(n=>Math.abs(n.drainResistanceBonus)/100);s.sort((n,r)=>r-n);let a=1;for(let n=0;n<s.length;n++){let r=Math.exp(-Math.pow(n/2.67,2));a*=1-s[n]*r}return-((1-a)*100)}
