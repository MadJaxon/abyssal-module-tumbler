addEventListener("message",n=>{switch(n.data.action){case"findCombinations":postMessage({action:n.data.action,data:T(n.data.data),isUpdate:!1});break;case"sort":postMessage({action:n.data.action,data:G(n.data.data),isUpdate:!1});break;default:postMessage({action:"sort",data:null,error:"unknown action",isUpdate:!1})}});function G(n){let s=n.makeUnique?L(n.results):n.results;return n.results=s.sort((u,l)=>{for(let t of Object.values(n.sorts)){let r=u[t.key],a=l[t.key];if(r==null&&a==null)continue;if(r==null)return t.direction==="asc"?-1:1;if(a==null)return t.direction==="asc"?1:-1;if(typeof r=="number"&&typeof a=="number"){if(r<a)return t.direction==="asc"?-1:1;if(r>a)return t.direction==="asc"?1:-1;continue}let o=String(r).toLowerCase(),c=String(a).toLowerCase();if(o<c)return t.direction==="asc"?-1:1;if(o>c)return t.direction==="asc"?1:-1}return 0}),n}function L(n){let s=[];return n.filter(u=>{let l=!0,t=[];return u.modules.forEach(r=>{s.some(a=>a.type===r.type&&a.index===r.index)&&(l=!1),t.push({type:r.type,index:r.index})}),l&&(s=s.concat(t)),l})}function T(n){let s=Object.keys(n.numModules).reduce((t,r)=>(t+=n.numModules[r],t),0);if(!n.cpuBudget||!n.pgBudget||!n.numModules||s<=0){n.error="Please enter valid budget and number of modules.";return}let u=[];N(n.modules,n.numModules).forEach((t,r)=>{let a=t.reduce((c,d)=>c+d.cpu,0),o=t.reduce((c,d)=>c+d.pg,0);if(a<=n.cpuBudget&&o<=n.pgBudget){let c=O(t.filter(e=>e.type==="dps")),d=t.filter(e=>e.type==="sb"),m=d.reduce((e,i)=>e+i.damage/(i.activationTime/1e3),0),b=d.reduce((e,i)=>e+i.activationCost/(i.activationTime/1e3),0),x=d.length===0?0:d.reduce((e,i)=>e+i.range,0)/d.length,f=t.filter(e=>e.type==="neut"),B=f.reduce((e,i)=>e+i.neutAmount/(i.activationTime/1e3),0),g=f.reduce((e,i)=>e+i.activationCost/(i.activationTime/1e3),0),v=f.length===0?0:f.reduce((e,i)=>e+i.range,0)/f.length,p=t.filter(e=>e.type==="nos"),D=p.reduce((e,i)=>e+i.drainAmount/(i.activationTime/1e3),0),w=p.length===0?0:p.reduce((e,i)=>e+i.range,0)/p.length,h=t.filter(e=>e.type==="battery"),W=h.reduce((e,i)=>e+i.capacitorBonus,0),S=P(h),y=t.filter(e=>e.type==="ab"),j=Math.max(...y.map(e=>e.velocityBonus)),k=Math.max(...y.map(e=>e.activationCost)),M=t.filter(e=>e.type==="mwd"),A=Math.max(...M.map(e=>e.velocityBonus)),R=Math.max(...M.map(e=>e.activationCost)),U=Math.max(...M.map(e=>e.signatureRadiusModifier)),I=Math.max(0,b)+Math.max(0,g)+Math.max(0,k,R);u.push({id:r,modules:t.map(e=>({type:e.type,index:e.index,itemId:e.itemId})),totalCpu:a,totalPg:o,dpsIncrease:c,smartbombDps:m,smartbombGjs:b,smartbombRange:x,neutAmount:B,neutGjs:g,neutRange:v,nosAmount:D,nosRange:w,capBonus:W,drainResistance:S,abVelocity:j,abGj:k,mwdVelocity:A,mwdGj:R,mwdSignature:U,totalGj:I}),postMessage({action:"findCombinations",data:u.length,isUpdate:!0})}});debugger;return n.results=u,n}function C(n,s){if(s===0)return[[]];if(n.length<s)return[];let u=[];for(let l=0;l<=n.length-s;l++){let t=n[l],r=C(n.slice(l+1),s-1);for(let a of r)u.push([t,...a])}return u}function E(n){return n.reduce((s,u)=>{let l=[];for(let t of s)for(let r of u)l.push([...t,...r]);return l},[[]])}function N(n,s){let u={},l=Object.keys(n);for(let a of l){let o=n[a],c=s[a]??0,d=[];for(let m=0;m<=Math.min(c,o.length);m++)d.push(...C(o,m));u[a]=d}let t=l.map(a=>u[a]);return E(t).filter(a=>!Object.keys(s).some(o=>a.filter(c=>c.type===o).length!==s[o]))}function O(n){let s=n.map(o=>o.dmgMulti-1),u=n.map(o=>o.rofBonus/100);s.sort((o,c)=>c-o),u.sort((o,c)=>c-o);let l=1;for(let o=0;o<s.length;o++){let c=Math.exp(-Math.pow(o/2.67,2));l*=1+s[o]*c}let t=1;for(let o=0;o<u.length;o++){let c=Math.exp(-Math.pow(o/2.67,2));t*=1-u[o]*c}let r=t>0?1/t:1;return(l*r-1)*100}function P(n){let s=n.map(t=>Math.abs(t.drainResistanceBonus)/100);s.sort((t,r)=>r-t);let u=1;for(let t=0;t<s.length;t++){let r=Math.exp(-Math.pow(t/2.67,2));u*=1-s[t]*r}return-((1-u)*100)}
